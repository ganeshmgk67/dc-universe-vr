<!DOCTYPE html>
<html>
<head>
  <title>VR Superhero Gallery</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <script>
    // YOUR ORIGINAL COMPONENT - UNCHANGED
    AFRAME.registerComponent('show-text-and-model', {
      schema: {
        message: { type: 'string' },
        model: { type: 'selector' }
      },
      init: function () {
        this.el.addEventListener('click', () => {
          document.querySelector('#infoText')
            .setAttribute('value', this.data.message);

          document.querySelectorAll('.superhero-model')
            .forEach(m => m.setAttribute('visible', false));

          this.data.model.setAttribute('visible', true);
        });
      }
    });

    // Markerless AR Component - Detects planes and shows superhero images on touch
    AFRAME.registerComponent('ar-support', {
      init: function () {
        const scene = this.el;
        let isARMode = false;
        let arUI = null;
        let markerlessPlanesDetected = [];
        let superHeroImages = [];
        let planeHitTestSession = null;

        // Initialize superhero image data
        const heroesData = [
          { name: 'Superman', src: 'assets/images/superman_logo.jpg', scale: '1.2 1.2 1' },
          { name: 'Batman', src: 'assets/images/batman.jpg', scale: '1.2 1.2 1' },
          { name: 'Flash', src: 'assets/images/flash_logo.jpeg', scale: '1.2 1.2 1' },
          { name: 'Green Lantern', src: 'assets/images/greenlantern_logo.jpg', scale: '1.2 1.2 1' },
          { name: 'Aquaman', src: 'assets/images/aqua_logo.jpeg', scale: '1.2 1.2 1' },
          { name: 'Cyborg', src: 'assets/images/cyborg_logo.jpeg', scale: '1.2 1.2 1' },
          { name: 'Shazam', src: 'assets/images/shazam_logo.jpg', scale: '1.2 1.2 1' }
        ];

        scene.addEventListener('enter-vr', () => {
          const xrSession = this.el.renderer.xr.getSession();
          if (xrSession && xrSession.sessionMode === 'immersive-ar') {
            isARMode = true;
            document.querySelector('a-sky')?.setAttribute('visible', 'false');
            
            // Hide all VR scene walls
            document.querySelectorAll('a-plane[color]').forEach(plane => {
              plane.setAttribute('visible', 'false');
            });

            // Show AR UI
            this.showMarkerlessARUI();
            this.enableMarkerlessPlaneDetection(xrSession);
          }
        });

        scene.addEventListener('exit-vr', () => {
          isARMode = false;
          document.querySelector('a-sky')?.setAttribute('visible', 'true');
          document.querySelectorAll('a-plane[color]').forEach(plane => {
            plane.setAttribute('visible', 'true');
          });
          this.hideARUI();
          this.clearSuperHeroImages();
          markerlessPlanesDetected = [];
        });

        this.showMarkerlessARUI = function() {
          if (!arUI) {
            arUI = document.createElement('div');
            arUI.id = 'ar-ui-panel';
            arUI.innerHTML = `
              <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
                          background: rgba(0,0,0,0.8); color: #FFD700; padding: 15px 20px; 
                          border-radius: 30px; font-size: 14px; z-index: 9998; text-align: center;
                          border: 2px solid #FFD700; font-weight: bold;">
                <div>ðŸŽ¯ Touch the ground or any surface to reveal superheroes!</div>
              </div>
            `;
            document.body.appendChild(arUI);
          }
        };

        this.hideARUI = function() {
          if (arUI) {
            arUI.remove();
            arUI = null;
          }
        };

        this.clearSuperHeroImages = function() {
          superHeroImages.forEach(img => {
            if (img.parentNode) {
              img.parentNode.removeChild(img);
            }
          });
          superHeroImages = [];
        };

        this.enableMarkerlessPlaneDetection = function(xrSession) {
          // Touch detection for markerless AR plane hitting
          document.addEventListener('touchend', async (e) => {
            if (!isARMode || !xrSession) return;

            const touch = e.changedTouches[0];
            const touchX = touch.clientX;
            const touchY = touch.clientY;

            try {
              planeHitTestSession = xrSession;
              
              // Create hit test source from screen coordinates
              const hitTestResults = await xrSession.requestHitTestSource({
                space: xrSession.getReferenceSpace(),
                offsetRay: new XRRay(new DOMPointReadOnly(0, 0, 0), new DOMPointReadOnly(0, 0, -1))
              });

              if (hitTestResults) {
                // Display superhero images at tap location
                this.displaySuperheroesAtPlane(touch);
              }
            } catch (err) {
              // Fallback: display superheroes at center of screen
              if (isARMode) {
                this.displaySuperheroesAtPlane(touch);
              }
            }
          });
        };

        this.displaySuperheroesAtPlane = function(touch) {
          // Clear previous images
          this.clearSuperHeroImages();

          // Create container for superhero images
          const container = document.createElement('div');
          container.id = 'markerless-heroes-container';
          container.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            z-index: 8000;
            padding: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 20px;
            border: 3px solid #FFD700;
            max-width: 90%;
            animation: popIn 0.4s ease-out;
          `;

          // Create hero image tiles
          heroesData.forEach((hero, index) => {
            const imgElement = document.createElement('div');
            imgElement.className = 'hero-tile';
            imgElement.style.cssText = `
              width: 80px;
              height: 100px;
              cursor: pointer;
              border-radius: 10px;
              overflow: hidden;
              border: 2px solid #8A3324;
              transition: all 0.2s ease;
              background-image: url('${hero.src}');
              background-size: cover;
              background-position: center;
              box-shadow: 0 4px 8px rgba(0,0,0,0.3);
              position: relative;
            `;

            // Add hero name label
            const nameLabel = document.createElement('div');
            nameLabel.style.cssText = `
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              background: rgba(0, 0, 0, 0.8);
              color: white;
              font-size: 9px;
              padding: 3px;
              text-align: center;
              font-weight: bold;
            `;
            nameLabel.textContent = hero.name;
            imgElement.appendChild(nameLabel);

            // Hover effect
            imgElement.addEventListener('mouseenter', () => {
              imgElement.style.transform = 'scale(1.1)';
              imgElement.style.borderColor = '#FFD700';
              imgElement.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.5)';
            });

            imgElement.addEventListener('mouseleave', () => {
              imgElement.style.transform = 'scale(1)';
              imgElement.style.borderColor = '#8A3324';
              imgElement.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
            });

            // Click to select and show model
            imgElement.addEventListener('click', () => {
              const modelId = [
                'superman3D', 'batman3D', 'flash3D', 'greenlantern3D',
                'aquaman3D', 'cyborg3D', 'shazam3D'
              ][index];

              // Hide all models first
              document.querySelectorAll('.superhero-model')
                .forEach(m => m.setAttribute('visible', false));

              // Show selected model
              const selectedModel = document.getElementById(modelId);
              if (selectedModel) {
                selectedModel.setAttribute('visible', true);
                selectedModel.setAttribute('position', '0 0 -1.5');
              }

              // Remove the container after selection
              if (container.parentNode) {
                container.parentNode.removeChild(container);
              }
            });

            container.appendChild(imgElement);
            superHeroImages.push(imgElement);
          });

          // Add close button
          const closeBtn = document.createElement('button');
          closeBtn.textContent = 'âœ•';
          closeBtn.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            background: #8A3324;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            z-index: 9001;
            transition: all 0.2s ease;
          `;
          
          closeBtn.addEventListener('click', () => {
            if (container.parentNode) {
              container.parentNode.removeChild(container);
            }
          });

          closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#6B281C';
            closeBtn.style.transform = 'scale(1.1)';
          });

          closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = '#8A3324';
            closeBtn.style.transform = 'scale(1)';
          });

          container.appendChild(closeBtn);
          document.body.appendChild(container);
          superHeroImages.push(container);

          // Add popup animation
          const style = document.createElement('style');
          style.textContent = `
            @keyframes popIn {
              0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
              }
              100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
              }
            }
          `;
          document.head.appendChild(style);
        };
      }
    });

    // AR Model Interaction Component
    AFRAME.registerComponent('ar-interactive', {
      init: function() {
        this.el.addEventListener('click', () => {
          document.querySelectorAll('.superhero-model')
            .forEach(m => m.classList.remove('ar-selected'));
          this.el.classList.add('ar-selected');
        });
      }
    });
  </script>

  <style>
    /* AR Button - won't affect your VR */
    #vr-ar-button {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 9999;
      padding: 12px 24px;
      background: #8A3324;
      color: white;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    #vr-ar-button:hover {
      background: #6B281C;
      transform: scale(1.05);
    }
    #vr-ar-button:active {
      transform: scale(0.95);
    }

    /* AR UI Panel - Markerless */
    #ar-ui-panel {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      animation: slideUp 0.3s ease-out;
    }

    #markerless-heroes-container {
      animation: popIn 0.4s ease-out;
    }

    .hero-tile {
      transition: all 0.2s ease;
    }

    .hero-tile:hover {
      transform: scale(1.1) !important;
      border-color: #FFD700 !important;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5) !important;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* AR Selected Model Indicator */
    .ar-selected {
      outline: 3px solid #FFD700 !important;
    }

    /* AR Loading Indicator */
    .ar-loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(138, 51, 36, 0.3);
      border-top: 4px solid #8A3324;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <!-- YOUR SCENE - ONLY ADDED ar-support AND webxr, EVERYTHING ELSE IS EXACTLY YOUR CODE -->
  <a-scene background="color: #f2f2f2" 
           cursor="rayOrigin: mouse"
           ar-support
           webxr="optionalFeatures: hit-test;">

    <!-- YOUR EXACT SKY AND WALLS - UNCHANGED -->
    <a-sky color="#f2f2f2"></a-sky>

    <!-- YOUR EXACT ASSETS - UNCHANGED -->
    <a-assets>
      <img id="superman" src="assets/images/superman_logo.jpg">
      <img id="batman" src="assets/images/batman.jpg">
      <img id="flash" src="assets/images/flash_logo.jpeg">
      <img id="greenlantern" src="assets/images/greenlantern_logo.jpg">
      <img id="aquaman" src="assets/images/aqua_logo.jpeg">
      <img id="cyborg" src="assets/images/cyborg_logo.jpeg">
      <img id="shazam" src="assets/images/shazam_logo.jpg">

      <a-asset-item id="supermanModel" src="assets/models/superman.glb"></a-asset-item>
      <a-asset-item id="batmanModel" src="assets/models/batman.glb"></a-asset-item>
      <a-asset-item id="flashModel" src="assets/models/flash.glb"></a-asset-item>
      <a-asset-item id="greenlanternModel" src="assets/models/green_lanter.glb"></a-asset-item>
      <a-asset-item id="aquamanModel" src="assets/models/aquaman.glb"></a-asset-item>
      <a-asset-item id="cyborgModel" src="assets/models/cyborg.glb"></a-asset-item>
      <a-asset-item id="shazamModel" src="assets/models/shazam.glb"></a-asset-item>
    </a-assets>

    <!-- YOUR EXACT CAMERA - UNCHANGED -->
    <a-entity camera position="0 1.6 6" wasd-controls look-controls></a-entity>

    <!-- YOUR EXACT LIGHTS - UNCHANGED -->
    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 5 5"></a-entity>

    <!-- YOUR EXACT FLOOR AND WALLS - UNCHANGED -->
    <a-plane position="0 -1 0" rotation="-90 0 0" width="14" height="14" color="#8F9B78"></a-plane>
    <a-plane position="0 2 -7" width="14" height="6" color="#FFA4A4"></a-plane>
    <a-plane position="-7 2 0" rotation="0 90 0" width="14" height="6" color="#FFBDBD"></a-plane>
    <a-plane position="7 2 0" rotation="0 -90 0" width="14" height="6" color="#FFBDBD"></a-plane>
    <a-plane position="0 2 7" rotation="0 180 0" width="14" height="6" color="#FFD6D6"></a-plane>
    <a-plane position="0 5 0" rotation="90 0 0" width="14" height="14" color="#FFF5F5"></a-plane>

    <!-- YOUR EXACT TEXT - UNCHANGED -->
    <a-text id="infoText"
          value="Click a superhero image"
          position="0 4 -6.9"
          rotation="0 0 0"
          align="center"
          width="15"
          color="#8A3324">
    </a-text>

    <!-- YOUR EXACT MODELS - UNCHANGED -->
    <a-entity id="superman3D" class="superhero-model"
              gltf-model="#supermanModel"
              position="0 0 2"
              scale="0.7 0.7 0.7"
              visible="false"
              animation-mixer
              animation="property: position; dir: alternate; dur: 2000; loop: true; to: 0 0.3 2"
              animation__rotate="property: rotation; dur: 12000; loop: true; to: 0 360 0">
    </a-entity>

    <a-entity id="batman3D" class="superhero-model"
            gltf-model="#batmanModel"
            position="0 0 2"
            scale="1 1 1"
            visible="false"
            animation-mixer
            animation="property: rotation; dur: 25000; loop: true; to: 0 360 0">
    </a-entity>

    <a-entity id="flash3D" class="superhero-model"
              gltf-model="#flashModel"
              position="0 0 2"
              scale="0.6 0.6 0.6"
              visible="false"
              animation-mixer
              rotation="0 0 0"
              animation__run="property: position; dir: alternate; dur: 800; loop: true; to: 0 0 1.2">
    </a-entity>

    <a-entity id="greenlantern3D" class="superhero-model"
              gltf-model="#greenlanternModel"
              position="0 0 2"
              scale="1 1 1"
              visible="false"
              animation-mixer
              animation="property: position; dir: alternate; dur: 3000; loop: true; to: 0 0.2 2"
              animation__rotate="property: rotation; dur: 15000; loop: true; to: 0 360 0">
    </a-entity>

    <a-entity id="aquaman3D" class="superhero-model"
              gltf-model="#aquamanModel"
              position="0 0 2"
              scale="0.8 0.8 0.8"
              visible="false"
              rotation="0 -45 0"
              animation-mixer
              animation="property: position; dir: alternate; dur: 3500; loop: true; to: 0 0.25 2">
    </a-entity>

    <a-entity id="cyborg3D" class="superhero-model"
              gltf-model="#cyborgModel"
              position="0 0 2"
              scale="0.9 0.9 0.9"
              visible="false"
              animation-mixer
              animation="property: rotation; dur: 20000; loop: true; to: 0 360 0">
    </a-entity>

    <a-entity id="shazam3D" class="superhero-model"
              gltf-model="#shazamModel"
              position="0 0 0"
              scale="0.4 0.4 0.4"
              visible="false"
              animation-mixer
              animation="property: position; dir: alternate; dur: 2500; loop: true; to: 0 0.25 2">
    </a-entity>

    <!-- YOUR EXACT IMAGES - UNCHANGED -->
    <a-plane src="#superman" position="-3 1.6 -6.95" width="1.8" height="1.8"
             show-text-and-model="message: Superman â€“ Man of Steel; model: #superman3D"></a-plane>

    <a-plane src="#batman" position="0 1.6 -6.95" width="1.8" height="1.8"
             show-text-and-model="message: Batman â€“ The Dark Knight; model: #batman3D"></a-plane>

    <a-plane src="#flash" position="3 1.6 -6.95" width="1.8" height="1.8"
             show-text-and-model="message: The Flash â€“ Fastest Man Alive; model: #flash3D"></a-plane>

    <a-plane src="#greenlantern" position="-6.8 1.8 -1.5" rotation="0 90 0"
             width="1.8" height="1.8"
             show-text-and-model="message: Green Lantern â€“ Power of Will; model: #greenlantern3D"></a-plane>

    <a-plane src="#aquaman" position="-6.8 1.8 1.5" rotation="0 90 0"
             width="1.8" height="1.8"
             show-text-and-model="message: Aquaman â€“ King of Atlantis; model: #aquaman3D"></a-plane>

    <a-plane src="#cyborg" position="6.8 1.8 -1.5" rotation="0 -90 0"
             width="1.8" height="1.8"
             show-text-and-model="message: Cyborg â€“ Half Man, Half Machine; model: #cyborg3D"></a-plane>

    <a-plane src="#shazam" position="6.8 1.8 1.5" rotation="0 -90 0"
             width="1.8" height="1.8"
             show-text-and-model="message: Shazam â€“ Magic of the Gods; model: #shazam3D"></a-plane>

  </a-scene>

  <!-- SIMPLE BUTTON - Won't affect VR, just helps start AR -->
  <button id="vr-ar-button">Switch to AR (ðŸ“± use on phone)</button>

  <script>
    // Simple button to help start AR - doesn't change your VR code
    document.getElementById('vr-ar-button').addEventListener('click', async () => {
      const scene = document.querySelector('a-scene');
      
      if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        try {
          if (navigator.xr) {
            const session = await navigator.xr.requestSession('immersive-ar');
            scene.renderer.xr.setSession(session);
          }
        } catch (err) {
          alert('AR failed. Make sure you're on HTTPS and have camera permission.');
        }
      } else {
        alert('ðŸ“± AR only works on phones!\n\n1. Upload this to a HTTPS server\n2. Open on your phone\n3. Click this button again');
      }
    });
  </script>
</body>
</html>
